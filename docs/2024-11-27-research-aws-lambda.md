# AWS Lambda の仕様

- [AWS Lambda の仕様](#aws-lambda-の仕様)
  - [PostgreSQL データベースの設定](#postgresql-データベースの設定)
    - [テーブルの設計](#テーブルの設計)
      - [投資対象テーブル (Investment)](#投資対象テーブル-investment)
      - [価格履歴テーブル (PriceHistory)](#価格履歴テーブル-pricehistory)
      - [リターンリスクテーブル (ReturnAndRisk)](#リターンリスクテーブル-returnandrisk)
  - [Lambda 1: 株価データを収集し， DB に保存](#lambda-1-株価データを収集し-db-に保存)
    - [概要](#概要)
    - [仕様](#仕様)
      - [1. Lambda 関数の作成](#1-lambda-関数の作成)
      - [2. 処理内容](#2-処理内容)
      - [3. トリガーの設定](#3-トリガーの設定)
  - [Lambda 2: 期待値と標準偏差を計算し， DB に保存](#lambda-2-期待値と標準偏差を計算し-db-に保存)
    - [概要](#概要-1)
    - [仕様](#仕様-1)
      - [1. Lambda 関数の作成](#1-lambda-関数の作成-1)
      - [2. 処理内容](#2-処理内容-1)
      - [3. トリガーの設定](#3-トリガーの設定-1)
  - [Lambda 3: フロントからのリクエストを受け取り， 計算して返す](#lambda-3-フロントからのリクエストを受け取り-計算して返す)
    - [概要](#概要-2)
    - [仕様](#仕様-2)
      - [1. Lambda 関数の作成](#1-lambda-関数の作成-2)
      - [2. 処理内容](#2-処理内容-2)
      - [3. トリガーの設定](#3-トリガーの設定-2)
      - [4. デプロイとテスト](#4-デプロイとテスト)
  - [悩み事](#悩み事)
    - [API Gateway](#api-gateway)
    - [重みの扱い](#重みの扱い)
    - [分析期間](#分析期間)

## PostgreSQL データベースの設定

- AWS RDS を使用．
- RDBMS: PostgreSQL

### テーブルの設計

3 つのテーブルを作成

- 投資対象テーブル (Investment)
- 価格履歴テーブル (PriceHistory)
- リターンリスクテーブル (ReturnAndRisk)

#### 投資対象テーブル (Investment)

- 目的: 各投資対象の基本情報を保存する．
- カラム:

  - InvestmentID: 主キー
  - Ticker: 投資対象のティッカーシンボル
  - Name: 投資対象の名前

- サンプルデータ

  | InvestmentID | Ticker | Name                             |
  | ------------ | ------ | -------------------------------- |
  | 1            | IVV    | i シェアーズ・コア S&P 500 ETF   |
  | 2            | VGK    | バンガード FTSE ヨーロッパ ETF   |
  | 3            | VPL    | バンガード FTSE パシフィック ETF |

#### 価格履歴テーブル (PriceHistory)

- 目的: 各投資対象の価格履歴を保存する．
- カラム:

  - PriceHistoryID: 価格履歴の識別子 (主キー)
  - InvestmentID: 投資対象の識別子 (外部キーとして Investment テーブルの InvestmentID を参照)
  - Date: 価格データの日付
  - P: その日の調整済終値

- サンプルデータ

  | PriceHistoryID | InvestmentID | Date       | P   |
  | -------------- | ------------ | ---------- | --- |
  | 1              | 1            | 2021-01-01 | 100 |
  | 2              | 1            | 2021-01-02 | 101 |
  | 3              | 2            | 2021-01-01 | 200 |
  | 4              | 2            | 2021-01-02 | 201 |
  | 5              | 3            | 2021-01-01 | 300 |
  | 6              | 3            | 2021-01-02 | 301 |

#### リターンリスクテーブル (ReturnAndRisk)

- 目的: 各投資対象の期待値と標準偏差を保存する．
- カラム:

  - ReturnAndRiskID: リターンリスクの識別子 (主キー)
  - InvestmentID: 投資対象の識別子 (外部キーとして Investment テーブルの InvestmentID を参照)
  - ExpectedValue: 期待値
  - StandardDeviation: 標準偏差

- サンプルデータ

  | ReturnRiskID | InvestmentID | ExpectedValue | StandardDeviation |
  | ------------ | ------------ | ------------- | ----------------- |
  | 1            | 1            | 0.1           | 0.2               |
  | 2            | 2            | 0.08          | 0.15              |
  | 3            | 3            | 0.09          | 0.18              |

## Lambda 1: 株価データを収集し， DB に保存

### 概要

yahoo finance から株価データを収集し， PostgreSQL データベース に保存する AWS Lambda 関数．

### 仕様

#### 1. Lambda 関数の作成

- 関数名: CollectStockPriceData
- ランタイム: Python 3.12
- 実行ロール: 勉強する．

#### 2. 処理内容

1. PostgreSQL に接続

2. 投資テーブルから銘柄を取得

   投資 ID と ticker を取得する

3. 投資 ID でループ

4. Yahoo Finance API からデータを取得

   ticker を使用して最新の株価データ (調整済終値) を取得．

   ※ 調整済終値: 株式分割による株価の分割を考慮した終値．

   ※ 株式分割: 1 株 1,000 円の株が 10 株に分割され，1 株 100 円になることがしばしばある．

5. データの整形

   - InvestmentID: 投資 ID
   - Date: 日付
   - P: 調整済終値

6. 価格履歴テーブルにデータを保存

#### 3. トリガーの設定

- トリガー: CloudWatch Events
- スケジュール: 1 日 1 回

## Lambda 2: 期待値と標準偏差を計算し， DB に保存

### 概要

- Lambda 2 は Lambda 1 が完了したタイミングで実行される．
- 価格履歴テーブルからデータを取得する．
- 各銘柄の期待値と標準偏差を計算する．
- 結果を投資テーブルに保存する．

### 仕様

#### 1. Lambda 関数の作成

- 関数名: CalculateReturnAndRisk
- ランタイム: Python 3.12
- 実行ロール: 勉強する．

#### 2. 処理内容

1. PostgreSQL に接続

2. 投資テーブルから 投資 ID を取得

3. 投資 ID でループ

4. 価格履歴テーブルから投資 ID に対応するデータを取得

5. リターンと標準偏差を計算

   - リターン:

     勉強中

   - 標準偏差:

     勉強中

6. リターンリスクテーブルにデータを保存

#### 3. トリガーの設定

- トリガー: Lambda 1 の完了 (Step Functions でできそう)
- スケジュール: 1 日 1 回

## Lambda 3: フロントからのリクエストを受け取り， 計算して返す

### 概要

Lambda 3 はフロントエンドからのリクエストを受け取り， 指定された銘柄名と重みに基づいて，リターンと標準偏差を計算して，結果を返す．

### 仕様

#### 1. Lambda 関数の作成

- 関数名: CalculatePortfolioMetrics
- ランタイム: Python 3.12
- 実行ロール: 勉強する．

#### 2. 処理内容

1. PostgresSQL に接続

2. リクエストの受取

3. リターンリスクテーブルからデータを取得

4. ポートフォリオのリターンと標準偏差を計算

   - $\mathbf{r}$ : 期待リターン ($r_1, r_2, \cdots, r_n$)
   - $\mathbf{\Sigma}$: 分散共分散行列
   - $\mathbf{w}$: ポートフォリオウェート ($w_1, w_2, \cdots, w_n$)

   - ポートフォリオの期待幾何平均:

     $$
     G(r_p) = \exp(\mathbf{w}^T\log(1 + \mathbf{r})) - 1
     $$

   - ポートフォリオの期待標準偏差:

   $$
   \sigma_p = \sqrt{\mathbf{w}^T \mathbf{\Sigma} \mathbf{w}}
   $$

   - ポートフォリオの期待幾何シャープレシオ:

     $$
     S_p = \frac{G(r_p)}{\sigma_p}
     $$

5. 結果を返す

#### 3. トリガーの設定

- トリガー: API Gateway
- スケジュール: リクエストがあるたび

#### 4. デプロイとテスト

## 悩み事

### API Gateway

HTTP リクエストを受け取り，それを Lambda 関数に渡すためのサービス．

REST API で リクエストを飛ばし， MongoDB にアクセスして追記とかはやったことがある．

### 重みの扱い

- ユーザーが銘柄名と重みを指定し，期待値と標準偏差を返す．

- ユーザーが銘柄名を指定し，最大期待値，最大シャープレシオのポートフォリオを構成する重みを返す．

後者は，最適化問題になるため，余裕があれば機能追加する．

### 分析期間

データが新しすぎても，古すぎてもだめ．

ユーザーが分析期間を指定するのが良いかもしれないが，余裕があれば追加する．
